#!/usr/bin/env php
<?php

declare(strict_types=1);

use PhpAT\App\Provider;
use PhpAT\Input\ArgvInput;
use Symfony\Component\DependencyInjection\ContainerBuilder;

$autoload = is_file(__DIR__.'/../../autoload.php')
    ? __DIR__.'/../../autoload.php'
    : __DIR__.'/vendor/autoload.php';

require $autoload;

if (PHP_VERSION_ID < 70100) {
    \fwrite(\STDERR, 'Required at least PHP version 7.1.0 but your version is '.PHP_VERSION.PHP_EOL);
    exit(1);
}

$input = new ArgvInput();

$container = new ContainerBuilder();
$provider  = new Provider($container, $autoload, $input);
$container = $provider->register();

try {
    $app = $container->get('app');
    $app->execute();
} catch (\Exception $e) {
    $redBgWhiteText = "\033[41m\033[1;37m";
    $formattingReset = "\033[0m";

    echo sprintf(
        "%s\n\n\tAn error occurred while running phpat.\n%s\n",
        $redBgWhiteText,
        $formattingReset
    );
    do {
        $limitedErrorMessage = implode("\n", str_split($e->getMessage(), 80));
        echo sprintf(
            "=================\n%s\n\nIn %s:%d\n%s",
            $limitedErrorMessage,
            $e->getFile(),
            $e->getLine(),
            $e->getTraceAsString()
        );
    } while ($e = $e->getPrevious());

    exit(1);
}
